# üöÄ Master Supabase RBAC: Update JWT Tokens with User Roles (Next.js SQL Guide)

A comprehensive, step-by-step guide to implementing a secure role-based authentication system (Admin/User) using Supabase, Next.js, and PostgreSQL. Learn how to extend Supabase Auth with custom user roles, automatically populate user tables with triggers, and embed roles in JWT access tokens for secure API access.

## ‚≠ê Features Implemented:
- Custom SQL Roles (admin, user) in Supabase
- Automatic user profile creation on sign-up (via PostgreSQL triggers)
- Custom JWT Claims to embed user roles in the access token
- Secure Row Level Policies (RLS) ready foundation
- Next.js 14+ Integration

## üîç Tutorial Overview

This tutorial is divided into two logical parts:
1. Complete Supabase Setup: Integration and validation using a pre-built Next.js project.
2. Role-Based System Implementation: The core implementation of the RBAC system using custom SQL functions and triggers.

## üìö Table of Contents
- Prerequisites
- Part 1: Supabase Setup and Next.js Integration
- Part 2: Implementing Role-Based Authentication (RBAC)
- Verification & Testing
- Troubleshooting
- Next Steps

## üõ† Prerequisites
- A basic understanding of React/Next.js
- Node.js and npm installed on your local machine

## üß© Part 1: Supabase Setup and Nextjs Integration
### Step 1: Sign Up and Create a Supabase Project

1. Go to Supabase and create an account
2. Create a new project in your Supabase dashboard
3. Note your project URL and API keys for the next steps

### üõ° Part 2: Implementing Role-Based Authentication (RBAC)
```bash
npx create-next-app@latest -e with-supabase my-supabase-app
cd my-supabase-app
```

### Step 3: Configure Environment Variables
1. Copy the contents from .env.example to a new .env.local file
2. Update the credentials with your Supabase project details:

```bash
NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
```

### Step 4: Verify the Setup
1. Run the development server:
```bash
npm run dev
```
2. Open your browser and navigate to http://localhost:3000
3. Test the authentication flow to confirm the connection to Supabase is working

## Part 2: Role-Based Authentication System
### Database Schema Implementation
<img width="832" height="619" alt="image" src="https://github.com/user-attachments/assets/38e7a3e9-1394-43e6-b709-a3d045d46a76" />

### Create Custom Types and Tables
Run this SQL in your Supabase SQL editor:

```sql
-- Custom types
CREATE TYPE public.app_role AS ENUM ('admin', 'user');

-- USER ROLES TABLE
CREATE TABLE public.users (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id UUID REFERENCES auth.users ON DELETE CASCADE NOT NULL UNIQUE,
  img_url TEXT,
  role public.app_role NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

COMMENT ON TABLE public.users IS 'Stores application-specific user data and roles, linking to authentication users. Each user can have multiple role entries, enforcing unique role assignments per user.';

-- Create the trigger function for updated_at
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create the trigger
CREATE TRIGGER update_users_updated_at 
    BEFORE UPDATE ON public.users 
    FOR EACH ROW 
    EXECUTE FUNCTION update_updated_at_column();
```

### Link Supabase Auth with Custom Table
Run this SQL to automatically create user records on signup:

```sql
CREATE OR REPLACE FUNCTION public.set_role_on_signup()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  INSERT INTO public.users (user_id, role)
  VALUES (NEW.id, 'user');
  RETURN NEW;
END;
$$;

CREATE TRIGGER on_auth_user_created
AFTER INSERT ON auth.users
FOR EACH ROW
EXECUTE FUNCTION public.set_role_on_signup();
```

### Test User Creation
1. Create a test account through your Next.js application
2. Verify in the Supabase dashboard that a corresponding record was created in the public.users table

### Implement Custom Access Token Hook
Run this SQL to include user roles in JWT tokens:

```sql
-- Create the auth hook function
CREATE OR REPLACE FUNCTION public.custom_access_token_hook(event JSONB)
RETURNS JSONB
LANGUAGE plpgsql
STABLE
AS $$
DECLARE
  claims JSONB;
  user_role public.app_role;
BEGIN
  -- Fetch the user role from the public.users table
  SELECT role INTO user_role 
  FROM public.users 
  WHERE user_id = (event->>'user_id')::UUID;

  claims := event->'claims';

  IF user_role IS NOT NULL THEN
    -- Set the claim
    claims := jsonb_set(claims, '{user_role}', to_jsonb(user_role));
  ELSE
    claims := jsonb_set(claims, '{user_role}', 'null');
  END IF;
  
  -- Update the 'claims' object in the original event
  event := jsonb_set(event, '{claims}', claims);
  
  -- Return the modified or original event
  RETURN event;
END;
$$;

-- Grant necessary permissions
GRANT USAGE ON SCHEMA public TO supabase_auth_admin;
GRANT EXECUTE ON FUNCTION public.custom_access_token_hook TO supabase_auth_admin;
REVOKE EXECUTE ON FUNCTION public.custom_access_token_hook FROM authenticated, anon, public;

-- Grant access to the users table
GRANT ALL ON TABLE public.users TO supabase_auth_admin;
REVOKE ALL ON TABLE public.users FROM authenticated, anon, public;

-- Create policy for auth admin to read users table
CREATE POLICY "Allow auth admin to read users" ON public.users
AS PERMISSIVE FOR SELECT
TO supabase_auth_admin
USING (true);
```

### Configure Auth Hook in Supabase Dashboard
1. Go to your Supabase project dashboard
2. Navigate to Authentication ‚Üí Settings ‚Üí Auth Hooks
3. Enable "Custom Access Token Hook"
4. Set the function name to custom_access_token_hook
5. Save your changes

### Verification
Your authentication system should now be working with role-based access control. To verify:

1. Sign up a new user through your Next.js application
2. Check the Supabase dashboard to confirm the user was created with the default 'user' role
3. Inspect the JWT token to confirm it contains the user_role claim
4. Test authentication flows to ensure proper role-based access control

### Troubleshooting
- If users aren't being created in the public.users table, check the trigger function
- If roles aren't appearing in tokens, verify the auth hook configuration
- Ensure all SQL commands executed successfully without errors

This completes the setup of a role-based authentication system using Supabase and Next.js.


**Found this tutorial helpful?** Please give it a star ‚≠ê on GitHub to show your support!
